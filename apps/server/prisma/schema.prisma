// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}


/// User account - supports email, Google, and Apple OAuth
model User {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  email     String   @unique
  name      String
  avatar    String?  // Optional profile picture URL
  passwordHash String? // Null for OAuth users
  emailVerified Boolean @default(false)
  // Note: verificationToken uniqueness enforced in application logic
  // (MongoDB unique indexes only allow ONE null value)
  verificationToken String?
  // OAuth providers
  // Note: Not using @unique on nullable fields due to MongoDB limitation
  // (MongoDB unique indexes only allow ONE null value)
  // Uniqueness will be enforced in application logic
  googleId  String?
  appleId   String?
  
  // Subscription & billing
  subscriptionTier SubscriptionTier @default(FREE)
  subscriptionStatus SubscriptionStatus @default(INACTIVE)
  subscriptionStartDate DateTime?
  subscriptionEndDate DateTime?
  razorpayCustomerId String? @unique // Razorpay customer ID 
  
  // User preferences
  timezone String @default("UTC")
  userType String? // "student" | "professional" | "freelancer"
  preferredFocusTime String? // "morning" | "afternoon" | "evening" | "night"
  onboardingCompleted Boolean @default(false) // Track if user completed onboarding

  defaultSessionDuration Int @default(25) // minutes
  notificationsEnabled Boolean @default(true)
  
  // Gamification & stats (denormalized for performance)
  totalFocusTime Int @default(0) // in seconds
  totalSessions Int @default(0)
  completedSessions Int @default(0)
  failedSessions Int @default(0)
  currentStreak Int @default(0)
  longestStreak Int @default(0)
  lastSessionDate DateTime?

  // Calendar integration
  googleCalendarToken String?
  googleCalendarRefreshToken String?
  outlookCalendarToken String?
  outlookCalendarRefreshToken String?
  
  // AI usage tracking (for rate limiting)
  aiRequestsThisMonth Int @default(0)
  aiRequestsResetDate DateTime @default(now())
  
  // Mobile sync support
  lastSyncedAt DateTime? // Last time user synced from any device
  
  // Audit fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  lastLoginAt DateTime?
  deletedAt DateTime? // Soft delete
  
  // Relations
  tasks Task[]
  sessions FocusSession[]
  devices Device[]
  aiRequests AIRequest[]
  achievements UserAchievement[]
  weeklyInsights WeeklyInsight[]
  subscriptions Subscription[]
  payments Payment[]
  subscriptionAuditLogs SubscriptionAuditLog[]
  
  // Indexes for common queries
  @@index([subscriptionTier, subscriptionStatus])
  @@index([createdAt])
  @@index([deletedAt]) // For soft delete queries
  @@map("users")
}

/// Task - User's to-do items with AI breakdown support
model Task {
  id String @id @default(auto()) @map("_id") @db.ObjectId
  userId String @db.ObjectId
  
  // Task details
  title String
  description String?
  status TaskStatus @default(TODO)
  priority TaskPriority @default(MEDIUM)
  
  // Time management
  dueDate DateTime?
  estimatedMinutes Int? // User or AI estimated time
  actualMinutes Int @default(0) // Tracked from sessions
  
  // Organization
  tagIds String[] // Array of tag names (simple strings, no relation)
  
  // AI-generated breakdown
  isAIGenerated Boolean @default(false)
  aiPrompt String? // Original user prompt
  
  // Scheduling (AI auto-schedule feature)
  scheduledStartTime DateTime?
  scheduledEndTime DateTime?
  
  // Completion tracking
  completedAt DateTime?
  
  // Mobile sync support
  clientId String? @unique // Temporary client ID for sync mapping
  
  // Audit fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime? // Soft delete
  
  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  sessions FocusSession[]
  
  // Indexes for performance
  @@index([userId, status]) // List tasks by user and status
  @@index([userId, dueDate]) // Sort by due date
  @@index([userId, priority, status]) // Filter by priority
  @@index([createdAt])
  @@index([deletedAt])

  @@map("tasks")
}

/// FocusSession - Core focus timer sessions with tree growth tracking
model FocusSession {
  id String @id @default(auto()) @map("_id") @db.ObjectId
  userId String @db.ObjectId
  taskId String? @db.ObjectId // Optional: link to a task
  
  // Session configuration
  duration Int // Total planned duration in seconds  
  // Session timing
  startTime DateTime @default(now())
  endTime DateTime // Calculated: startTime + duration
  completedAt DateTime? // When user actually completed
  pausedAt DateTime? // When paused (if paused)
  failedAt DateTime? // When failed (if failed)
  
  // Session progress
  status SessionStatus @default(RUNNING)
  progress Int @default(0) // 0-100 percentage
  timeElapsed Int @default(0) // Actual seconds focused (excluding pauses)
  pauseDuration Int @default(0) // Total seconds paused
  
  // Session outcome
  reason SessionFailReason? // Why it failed (if failed)
  actualDuration Int? // Final duration when completed
  
  // Break management
  breakDuration Int @default(300) // 5 min default break in seconds
  breakTaken Boolean @default(false)
  
  // Device & platform tracking
  platform String? // "web", "ios", "android"
  deviceId String? // For cross-device detection
  
  // Mobile sync support
  clientId String? @unique // Temporary client ID for sync mapping
  
  // Audit fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  task Task? @relation(fields: [taskId], references: [id], onDelete: SetNull)
  
  // Indexes for queries and analytics
  @@index([userId, status]) // Active sessions
  @@index([userId, createdAt]) // Session history
  @@index([userId, status, startTime]) // Timeline view
  @@index([taskId]) // Sessions per task
  @@index([startTime, endTime]) // Date range queries
  @@index([status, updatedAt]) // Cleanup failed/stuck sessions

  @@map("focus_sessions")
}




// ============================================================================
// DEVICES & MOBILE SUPPORT
// ============================================================================

/// Device - Track user devices for push notifications and sync
model Device {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Device identification
  deviceId  String   @unique // Unique device identifier (UUID from client)
  platform  String   // "web" | "ios" | "android"
  osVersion String?  // Operating system version
  appVersion String  // App version for compatibility checks
  
  // Push notifications
  pushToken String?  // FCM/APNS push token
  
  // Device activity
  lastSeenAt DateTime @default(now())
  
  // Audit fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Indexes
  @@index([userId])
  @@index([userId, lastSeenAt]) // Find user's active devices
  @@index([platform]) // Analytics by platform
  @@map("devices")
}

// ============================================================================
// AI & INTELLIGENCE
// ============================================================================

/// AIRequest - Track all AI API calls for analytics and rate limiting
model AIRequest {
  id String @id @default(auto()) @map("_id") @db.ObjectId
  userId String @db.ObjectId
  
  // Request details
  requestType AIRequestType // TASK_BREAKDOWN, SCHEDULE_SUGGEST, etc.
  prompt String // User's input
  response String // AI's output (can be large)
  
  // AI provider details
  provider String @default("gemini") // "gemini", "openai", "claude"
  model String @default("gemini-2.0-flash") // Specific model used
  tokensUsed Int? // For cost tracking
  
  // Performance tracking
  latencyMs Int? // Response time in milliseconds
  
  // Status
  status AIRequestStatus @default(SUCCESS)
  errorMessage String?
  
  // Audit
  createdAt DateTime @default(now())
  
  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Indexes for analytics and rate limiting
  @@index([userId, createdAt]) // User's AI history
  @@index([userId, requestType, createdAt]) // Rate limiting by type
  @@index([status, createdAt]) // Monitor failures
  @@map("ai_requests")
}

// ============================================================================
// GAMIFICATION & ACHIEVEMENTS
// ============================================================================

/// UserAchievement - Tracks user's unlocked achievements
model UserAchievement {
  id String @id @default(auto()) @map("_id") @db.ObjectId
  userId String @db.ObjectId
  
  // Achievement details
  achievementId String // Reference to achievement definition
  category AchievementCategory
  tier AchievementTier
  
  // Progress tracking
  progress Int @default(0) // 0-100
  unlockedAt DateTime?
  
  // Audit fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Indexes
  @@index([userId, category])
  @@index([userId, unlockedAt])
  @@unique([userId, achievementId])
  @@map("user_achievements")
}

// ============================================================================
// NOTIFICATIONS & COMMUNICATION
// ============================================================================


// ============================================================================
// ANALYTICS & INSIGHTS (Aggregated Data)
// ============================================================================

/// DailyStats - Pre-aggregated daily statistics for performance
model DailyStats {
  id String @id @default(auto()) @map("_id") @db.ObjectId
  userId String @db.ObjectId
  date DateTime // Just the date (no time) - MongoDB uses DateTime
  
  // Daily metrics
  totalFocusTime Int @default(0) // in seconds
  totalSessions Int @default(0)
  completedSessions Int @default(0)
  failedSessions Int @default(0)
  tasksCompleted Int @default(0)
  
  // Breakdown by time of day (optional, for insights)
  morningFocusTime Int @default(0) // 6-11 AM
  afternoonFocusTime Int @default(0) // 12-5 PM
  eveningFocusTime Int @default(0) // 6-11 PM
  nightFocusTime Int @default(0) // 12-5 AM
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Prevent duplicate daily records (unique constraint creates index automatically)
  @@unique([userId, date])
  @@map("daily_stats")
}

/// WeeklyInsight - AI-generated weekly insights and recommendations
model WeeklyInsight {
  id String @id @default(auto()) @map("_id") @db.ObjectId
  userId String @db.ObjectId
  
  // Week identification
  weekStart DateTime // Monday of that week (00:00:00)
  weekEnd DateTime   // Sunday of that week (23:59:59)
  
  // Generated content
  narrative String // AI-generated summary narrative
  insights Json    // Array of insight objects with type, message, confidence
  recommendations Json // Array of recommendation objects with action, reason, impact
  nextWeekPlan Json    // Array of planning items for next week
  oneLeverToPull String // Single highest-impact change
  
  // Metadata
  generationLatencyMs Int // How long AI took to generate
  weeklyStats Json // Aggregated stats used for generation
  model String @default("gemini-2.5-flash") // AI model used
  provider String @default("google")
  
  // Status tracking
  isRead Boolean @default(false) // Has user viewed the insight
  readAt DateTime?
  
  // Audit fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Indexes
  @@unique([userId, weekStart]) // One insight per user per week
  @@index([userId, createdAt])
  @@index([weekStart, weekEnd])
  @@map("weekly_insights")
}

// ============================================================================
// SUBSCRIPTION & PAYMENTS
// ============================================================================

/// Subscription - Track user subscription lifecycle
model Subscription {
  id String @id @default(auto()) @map("_id") @db.ObjectId
  userId String @db.ObjectId
  
  // Razorpay identifiers
  razorpaySubscriptionId String @unique // Razorpay subscription ID
  razorpayPlanId String // Razorpay plan ID
  razorpayCustomerId String // Razorpay customer ID
  
  // Plan details
  planType SubscriptionPlanType // MONTHLY, YEARLY
  planAmount Int // Amount in paise (9500 for monthly, 60000 for yearly)
  currency String @default("INR")
  
  // Billing cycle
  billingCycle Int // 1 for monthly, 12 for yearly
  currentPeriodStart DateTime
  currentPeriodEnd DateTime
  nextBillingDate DateTime?
  
  // Status management
  status SubscriptionStatus @default(ACTIVE)
  previousStatus SubscriptionStatus? // For tracking status changes
  
  // Lifecycle tracking
  activatedAt DateTime?
  pausedAt DateTime?
  cancelledAt DateTime?
  cancellationReason String? // User-provided reason
  cancelledBy String? // "user" | "admin" | "payment_failed"
  expiresAt DateTime? // When subscription actually expires
  
  // Auto-renewal
  autoRenew Boolean @default(true)
  renewalAttempts Int @default(0) // Track failed renewal attempts
  lastRenewalAttemptAt DateTime?
  
  // Trial (for future use)
  trialStart DateTime?
  trialEnd DateTime?
  isTrialUsed Boolean @default(false)
  
  // Payment tracking
  totalBillingCycles Int @default(0) // Number of successful charges
  totalAmountPaid Int @default(0) // In paise
  lastPaymentDate DateTime?
  nextPaymentAmount Int? // In paise
  
  // Metadata
  metadata Json? // Store additional Razorpay metadata
  notes Json? // Store custom notes
  
  // Audit fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  payments Payment[]
  
  // Indexes for queries
  @@index([userId, status])
  @@index([status, nextBillingDate]) // For renewal queries
  @@index([expiresAt]) // For expiry checks
  @@index([currentPeriodEnd]) // For validation queries
  @@map("subscriptions")
}

/// Payment - Track all payment transactions
model Payment {
  id String @id @default(auto()) @map("_id") @db.ObjectId
  userId String @db.ObjectId
  subscriptionId String? @db.ObjectId // Nullable for one-time payments
  
  // Razorpay identifiers
  razorpayPaymentId String @unique
  razorpayOrderId String
  razorpaySignature String? // For verification
  
  // Payment details
  amount Int // Amount in paise
  currency String @default("INR")
  status PaymentStatus @default(PENDING)
  
  // Payment method
  method PaymentMethod? // card, netbanking, wallet, upi
  cardNetwork String? // visa, mastercard, amex, rupay
  cardLast4 String? // Last 4 digits
  bankName String?
  walletName String? // paytm, phonepe, etc.
  vpa String? // UPI ID
  
  // Transaction details
  description String?
  email String? // Customer email at time of payment
  contact String? // Customer phone
  
  // Refund tracking
  isRefunded Boolean @default(false)
  refundedAmount Int @default(0) // In paise
  refundedAt DateTime?
  refundReason String?
  razorpayRefundId String?
  
  // Failure tracking
  errorCode String?
  errorDescription String?
  errorReason String? // Razorpay error reason
  failureSource String? // customer, business, bank
  retryCount Int @default(0)
  
  // Metadata
  metadata Json? // Store additional data
  
  // Audit fields
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  capturedAt DateTime? // When payment was captured
  
  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  subscription Subscription? @relation(fields: [subscriptionId], references: [id], onDelete: SetNull)
  
  // Indexes
  @@index([userId, status])
  @@index([razorpayOrderId])
  @@index([subscriptionId])
  @@index([status, createdAt])
  @@index([createdAt]) // For payment history queries
  @@map("payments")
}

/// WebhookEvent - Store all Razorpay webhooks for idempotency
model WebhookEvent {
  id String @id @default(auto()) @map("_id") @db.ObjectId
  
  // Razorpay webhook details
  razorpayEventId String @unique // For idempotency
  eventType RazorpayEventType
  accountId String? // Razorpay account ID
  
  // Payload
  payload Json // Complete webhook payload
  signature String // Razorpay signature for verification
  signatureVerified Boolean @default(false)
  
  // Processing status
  status WebhookStatus @default(PENDING)
  processedAt DateTime?
  failedAt DateTime?
  
  // Error handling
  errorMessage String?
  retryCount Int @default(0)
  maxRetries Int @default(3)
  nextRetryAt DateTime?
  
  // Associated entities
  userId String? @db.ObjectId // If identifiable
  subscriptionId String? @db.ObjectId
  paymentId String? @db.ObjectId
  
  // Audit
  receivedAt DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Indexes
  @@index([eventType, status])
  @@index([status, nextRetryAt]) // For retry queries
  @@index([receivedAt])
  @@index([userId]) // For user-specific webhook queries
  @@map("webhook_events")
}

/// SubscriptionAuditLog - Audit trail for compliance and debugging
model SubscriptionAuditLog {
  id String @id @default(auto()) @map("_id") @db.ObjectId
  
  // Entity tracking
  userId String @db.ObjectId
  subscriptionId String? @db.ObjectId
  paymentId String? @db.ObjectId
  
  // Action details
  action SubscriptionAction
  actor SubscriptionActor // USER, SYSTEM, ADMIN, WEBHOOK
  actorId String? // Admin user ID if applicable
  
  // State changes
  previousState Json? // Previous state snapshot
  newState Json? // New state snapshot
  changes Json? // Specific fields that changed
  
  // Context
  reason String? // Why this action was taken
  metadata Json? // Additional context
  ipAddress String?
  userAgent String?
  
  // Audit
  timestamp DateTime @default(now())
  
  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Indexes
  @@index([userId, timestamp])
  @@index([subscriptionId, timestamp])
  @@index([action, timestamp])
  @@index([actor, timestamp])
  @@map("subscription_audit_logs")
}

/// PlanConfiguration - Dynamic plan management
model PlanConfiguration {
  id String @id @default(auto()) @map("_id") @db.ObjectId
  
  // Plan identification
  planId String @unique // "pro_monthly", "pro_yearly"
  razorpayPlanId String @unique // Razorpay plan ID
  
  // Plan details
  name String // "Pro Monthly", "Pro Yearly"
  description String?
  tier SubscriptionTier // PRO
  billingPeriod SubscriptionPlanType // MONTHLY, YEARLY
  
  // Pricing
  amount Int // In paise
  currency String @default("INR")
  
  // Features & limits
  features Json // Array of features
  aiRequestsLimit Int? // null = unlimited
  maxDevices Int @default(5)
  exportEnabled Boolean @default(true)
  prioritySupport Boolean @default(true)
  
  // Availability
  isActive Boolean @default(true)
  availableFrom DateTime @default(now())
  availableUntil DateTime? // For limited-time plans
  
  // Marketing
  displayOrder Int @default(0)
  isPopular Boolean @default(false)
  savingsPercentage Float? // For yearly plan
  
  // Trial (optional)
  trialDays Int @default(0)
  
  // Metadata
  metadata Json?
  
  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([isActive, displayOrder])
  @@index([tier, billingPeriod])
  @@map("plan_configurations")
}

// ============================================================================
// ENUMS
// ============================================================================

enum SubscriptionTier {
  FREE
  PRO
  ENTERPRISE
}

enum SubscriptionStatus {
  ACTIVE
  INACTIVE
  TRIAL
  CANCELLED
  PAST_DUE
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  COMPLETED
  ARCHIVED
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum SessionStatus {
  RUNNING
  PAUSED
  COMPLETED
  FAILED
}

enum SessionFailReason {
  USER_GAVE_UP      // User clicked "Give Up"
  APP_BACKGROUNDED  // User left app >30s
  APP_CRASHED       // Technical failure
  DISTRACTION_OPENED // Opened blocked app (strict mode)
  TIMEOUT           // Session expired without action
}

enum AIRequestType {
  TASK_BREAKDOWN    // Break task into subtasks
  SCHEDULE_SUGGEST  // Suggest focus blocks
  POMODORO_OPTIMIZE // Personalized Pomodoro timing
  INSIGHT_GENERATE  // Weekly/monthly insights
  TASK_ESTIMATE     // Estimate task duration
}

enum AIRequestStatus {
  SUCCESS
  FAILED
  RATE_LIMITED
  TIMEOUT
}

enum AchievementCategory {
  SESSIONS       // Session milestones
  STREAK         // Streak milestones
  FOREST         // Tree collection
  FOCUS_TIME     // Total time milestones
  TASKS          // Task completion
  SPECIAL        // Seasonal/limited events
}

enum AchievementTier {
  BRONZE
  SILVER
  GOLD
  PLATINUM
  DIAMOND
}

enum NotificationType {
  SESSION_REMINDER  // "Time to focus!"
  BREAK_REMINDER    // "Take a break"
  STREAK_ALERT      // "Don't break your streak!"
  ACHIEVEMENT       // "Achievement unlocked!"
  SUBSCRIPTION      // Billing/subscription updates
  SYSTEM            // App updates, maintenance
}

// ============================================================================
// SUBSCRIPTION & PAYMENT ENUMS
// ============================================================================

enum SubscriptionPlanType {
  MONTHLY
  YEARLY
}

enum PaymentStatus {
  PENDING       // Payment initiated
  AUTHORIZED    // Payment authorized but not captured
  CAPTURED      // Payment successful
  FAILED        // Payment failed
  REFUNDED      // Full refund
  PARTIAL_REFUND // Partial refund
}

enum PaymentMethod {
  CARD
  NETBANKING
  WALLET
  UPI
  EMI
  CARDLESS_EMI
  PAYLATER
}

enum WebhookStatus {
  PENDING
  PROCESSING
  PROCESSED
  FAILED
  IGNORED     // Duplicate or irrelevant events
}

enum RazorpayEventType {
  // Subscription events
  SUBSCRIPTION_ACTIVATED
  SUBSCRIPTION_CHARGED
  SUBSCRIPTION_COMPLETED
  SUBSCRIPTION_PENDING
  SUBSCRIPTION_HALTED
  SUBSCRIPTION_CANCELLED
  SUBSCRIPTION_PAUSED
  SUBSCRIPTION_RESUMED
  SUBSCRIPTION_UPDATED
  
  // Payment events
  PAYMENT_AUTHORIZED
  PAYMENT_CAPTURED
  PAYMENT_FAILED
  PAYMENT_PENDING
  
  // Refund events
  REFUND_CREATED
  REFUND_PROCESSED
  REFUND_FAILED
  
  // Order events
  ORDER_PAID
}

enum SubscriptionAction {
  CREATED
  ACTIVATED
  UPGRADED
  DOWNGRADED
  RENEWED
  PAUSED
  RESUMED
  CANCELLED
  EXPIRED
  PAYMENT_SUCCEEDED
  PAYMENT_FAILED
  REFUND_ISSUED
  TRIAL_STARTED
  TRIAL_ENDED
}

enum SubscriptionActor {
  USER
  SYSTEM
  ADMIN
  WEBHOOK
  CRON_JOB
}
